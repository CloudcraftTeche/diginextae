{% extends 'base.html' %}
{% load static %}

{% block title %}Our Insights Management - Diginext{% endblock %}

{% block content %}

<div class="content-wrapper">
    <!-- Content Header -->
    <div class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1 class="m-0">Our Insights Management</h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                        <li class="breadcrumb-item active">Our Insights</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Display Messages -->
    {% if messages %}
    <div class="container-fluid">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            
            <!-- Statistics Card -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="small-box bg-primary">
                        <div class="inner">
                            <h3>{{ our_insights_count }}</h3>
                            <p>Total Our Insights</p>
                        </div>
                        <div class="icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Our Insights Section -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">All Our Insights</h3>
                            <div class="card-tools">
                                <button type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#createInsightModal">
                                    <i class="fas fa-plus"></i> Add New Insight
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            {% if our_insights %}
                            <div class="row">
                                {% for insight in our_insights %}
                                <div class="col-md-4 col-sm-6 mb-4">
                                    <div class="card h-100">
                                        {% if insight.image %}
                                        <img src="{{ insight.image.url }}" class="card-img-top" alt="{{ insight.title }}" style="height: 200px; object-fit: cover;">
                                        {% else %}
                                        <div class="bg-secondary text-center" style="height: 200px; display: flex; align-items: center; justify-content: center;">
                                            <i class="fas fa-image fa-3x text-white"></i>
                                        </div>
                                        {% endif %}
                                        <div class="card-body">
                                            <h5 class="card-title">{{ insight.title }}</h5>
                                            <p class="card-text">{{ insight.description|truncatewords:20 }}</p>
                                            <p class="mb-2">
                                                <i class="fas fa-clock text-muted"></i> 
                                                <strong>{{ insight.insight_date }}</strong>
                                            </p>
                                            <p>
                                                {% if insight.is_active %}
                                                <span class="badge badge-success">Active</span>
                                                {% else %}
                                                <span class="badge badge-secondary">Inactive</span>
                                                {% endif %}
                                            </p>
                                            <small class="text-muted">{{ insight.created_at|date:"M d, Y" }}</small>
                                        </div>
                                        <div class="card-footer text-center">
                                        <button type="button" class="btn btn-sm btn-info"
                                            onclick="openChallenges({{ insight.id }})">
                                            <i class="fas fa-list"></i> Challenges
                                        </button>

                                         <button type="button"
                                                    class="btn btn-sm btn-info"
                                                    onclick="editInsight(
                                                        {{ insight.pk }},
                                                        '{{ insight.category|default_if_none:''|escapejs }}',
                                                        '{{ insight.title|escapejs }}',
                                                        '{{ insight.description|escapejs }}',
                                                        '{{ insight.services|default_if_none:''|escapejs }}',
                                                        '{{ insight.insight_date|escapejs }}',
                                                        {{ insight.is_active|lower }},
                                                        '{% if insight.image %}{{ insight.image.url }}{% endif %}'
                                                    )">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>

                                            <button type="button" class="btn btn-sm btn-danger" onclick="deleteInsight('{% url 'our_insights_delete' insight.pk %}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle"></i> No insights found. Click "Add New Insight" to create one.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<!-- MODALS -->

<!-- Create Insight Modal -->
<div class="modal fade" id="createInsightModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" action="{% url 'our_insights_create' %}" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="modal-header bg-primary">
                    <h5 class="modal-title">Create Our Insight</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <div class="modal-body">

                    <!-- Category -->
                    <div class="form-group">
                        <label for="insight_category">Category</label>
                        <input
                            type="text"
                            class="form-control"
                            id="insight_category"
                            name="category"
                            placeholder="Enter category">
                    </div>

                    <!-- Title -->
                    <div class="form-group">
                        <label for="insight_title">Title <span class="text-danger">*</span></label>
                        <input
                            type="text"
                            class="form-control"
                            id="insight_title"
                            name="title"
                            placeholder="Enter title"
                            required>
                    </div>

                    <!-- Description -->
                    <div class="form-group">
                        <label for="insight_description">Description <span class="text-danger">*</span></label>
                        <textarea
                            class="form-control"
                            id="insight_description"
                            name="description"
                            rows="5"
                            placeholder="Enter description"
                            required></textarea>
                    </div>

                    <!-- Services (comma separated) -->
                    <div class="form-group">
                        <label for="insight_services">Services</label>
                        <input
                            type="text"
                            class="form-control"
                            id="insight_services"
                            name="services"
                            placeholder="e.g., Technical SEO, Content Strategy, Local SEO">
                        <small class="form-text text-muted">
                            Enter services separated by commas.  
                            Example: <em>Technical SEO, Content Strategy, Local SEO</em>
                        </small>
                    </div>

                    <!-- Insight Date -->
                    <div class="form-group">
                        <label for="insight_date">Insight Date <span class="text-danger">*</span></label>
                        <input
                            type="text"
                            class="form-control"
                            id="insight_date"
                            name="insight_date"
                            placeholder="e.g., 6 months, 1 week, 2 years"
                            required>
                        <small class="form-text text-muted">
                            Examples: "6 months", "1 week", "2 years", "3 days"
                        </small>
                    </div>

                    <!-- Image -->
                    <div class="form-group">
                        <label for="insight_image">Image <span class="text-danger">*</span></label>
                        <input
                            type="file"
                            class="form-control"
                            id="insight_image"
                            name="image"
                            accept="image/*"
                            required>
                        <small class="form-text text-muted">
                            Recommended size: 800×600px
                        </small>
                    </div>

                    <!-- Active -->
                    <div class="form-check">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="insight_is_active"
                            name="is_active">
                        <label class="form-check-label" for="insight_is_active">
                            Active
                        </label>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Create Insight</button>
                </div>

            </form>
        </div>
    </div>
</div>


<!-- Edit Insight Modal -->
<div class="modal fade" id="editInsightModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form method="POST" id="editInsightForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-header bg-info">
                    <h5 class="modal-title">Edit Our Insight</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <div id="edit_insight_image_preview"></div>

                    <!-- Category (Nullable) -->
                    <div class="form-group">
                        <label for="edit_insight_category">Category</label>
                        <input type="text"
                               class="form-control"
                               id="edit_insight_category"
                               name="category"
                               placeholder="e.g. Technical SEO, Content Strategy, Local SEO">
                    </div>

                    <div class="form-group">
                        <label for="edit_insight_title">Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="edit_insight_title" name="title" required>
                    </div>

                    <div class="form-group">
                        <label for="edit_insight_description">Description <span class="text-danger">*</span></label>
                        <textarea class="form-control"
                                  id="edit_insight_description"
                                  name="description"
                                  rows="5"
                                  required></textarea>
                    </div>

                    <!-- Services (Comma separated) -->
                    <div class="form-group">
                        <label for="edit_insight_services">Services</label>
                        <input type="text"
                               class="form-control"
                               id="edit_insight_services"
                               name="services"
                               placeholder="SEO Audit, Keyword Research, Local SEO">
                        <small class="form-text text-muted">
                            Enter services separated by commas
                            (e.g. SEO Audit, Content Marketing, Local SEO)
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="edit_insight_date">Insight Date <span class="text-danger">*</span></label>
                        <input type="text"
                               class="form-control"
                               id="edit_insight_date"
                               name="insight_date"
                               required>
                        <small class="form-text text-muted">
                            Examples: "6 months", "1 week", "2 years", "3 days"
                        </small>
                    </div>

                    <div class="form-group">
                        <label for="edit_insight_image">Image (leave empty to keep current)</label>
                        <input type="file"
                               class="form-control"
                               id="edit_insight_image"
                               name="image"
                               accept="image/*">
                        <small class="form-text text-muted">Recommended size: 800x600px</small>
                    </div>

                    <div class="form-check">
                        <input type="checkbox"
                               class="form-check-input"
                               id="edit_insight_is_active"
                               name="is_active">
                        <label class="form-check-label" for="edit_insight_is_active">Active</label>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-info">Update Insight</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- challenges Modal -->
<div class="modal fade" id="challengesModal" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">

            <form method="POST" id="challengesForm">
                {% csrf_token %}

                <div class="modal-header">
                    <h5 class="modal-title">Manage Challenges</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                </div>

                <div class="modal-body">
                    <input type="hidden" name="section_id" id="sectionId">

                    <input type="hidden" name="insight_id" id="modalInsightId">

                    <!-- Title -->
                    <div class="mb-3">
                        <label>Title</label>
                        <input type="text" name="title" id="challengeTitle" class="form-control">
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label>Description</label>
                        <textarea name="description" id="challengeDescription" class="form-control" rows="3"></textarea>
                    </div>

                    <!-- Challenges -->
                    <label class="fw-bold">Challenges</label>

                    <div id="challengeContainer"></div>

                    <button type="button" class="btn btn-sm btn-success mt-2" onclick="addChallengeField()">
                        + Add Challenge
                    </button>

                </div>

                <div class="modal-footer">
                    <button class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>

            </form>

        </div>
    </div>
</div>






<script>
// Edit Insight
function editInsight(
    id,
    category,
    title,
    description,
    services,
    insightDate,
    isActive,
    imageUrl
) {
    document.getElementById('editInsightForm').action =
        "{% url 'our_insights_edit' 0 %}".replace('0', id);

    // Set values
    document.getElementById('edit_insight_category').value = category || '';
    document.getElementById('edit_insight_title').value = title;
    document.getElementById('edit_insight_description').value = description;
    document.getElementById('edit_insight_services').value = services || '';
    document.getElementById('edit_insight_date').value = insightDate;
    document.getElementById('edit_insight_is_active').checked = isActive;

    // Image preview
    const imagePreview = document.getElementById('edit_insight_image_preview');
    if (imageUrl) {
        imagePreview.innerHTML = `
            <div class="mb-3">
                <label class="d-block mb-2"><strong>Current Image:</strong></label>
                <img src="${imageUrl}"
                     alt="Current image"
                     class="img-thumbnail"
                     style="max-width: 100%; max-height: 200px;">
            </div>
        `;
    } else {
        imagePreview.innerHTML = '<p class="text-muted mb-2">No image</p>';
    }

    $('#editInsightModal').modal('show');
}

// Delete Insight
function deleteInsight(url) {
    if (confirm('Are you sure you want to delete this insight?')) {
        window.location.href = url;
    }
}

function openChallenges(insightId) {

    fetch(`/dashboard/insights/${insightId}/challenges/get/`)
    .then(res => res.json())
    .then(data => {

        document.getElementById("modalInsightId").value = insightId;
        document.getElementById("challengeContainer").innerHTML = "";
        document.getElementById("sectionId").value = "";

        if (data.exists) {
            document.getElementById("sectionId").value = data.id;
            document.getElementById("challengeTitle").value = data.title;
            document.getElementById("challengeDescription").value = data.description;

            data.challenges.forEach(ch => addChallengeField(ch));
        } else {
            document.getElementById("challengesForm").reset();
            addChallengeField();
        }

        document.getElementById("challengesForm").action =
            `/dashboard/insights/${insightId}/challenges/`;

        $('#challengesModal').modal('show');
    });
}

function addChallengeField(value="") {
    let div = document.createElement("div");
    div.className = "d-flex mb-2";
    div.innerHTML = `
        <input type="text" name="challenges[]" class="form-control me-2" value="${value}">
        <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">×</button>
    `;
    document.getElementById("challengeContainer").appendChild(div);
}

// function addChallengeField(value = "") {
//     let container = document.getElementById("challengeContainer");

//     let div = document.createElement("div");
//     div.className = "d-flex mb-2";

//     div.innerHTML = `
//         <input type="text" name="challenges[]" class="form-control me-2" value="${value}" placeholder="Enter challenge">
//         <button type="button" class="btn btn-danger" onclick="this.parentElement.remove()">×</button>
//     `;

//     container.appendChild(div);
// }

// Auto-hide alerts
setTimeout(function() {
    $('.alert').fadeOut('slow');
}, 5000);
</script>

{% endblock %}